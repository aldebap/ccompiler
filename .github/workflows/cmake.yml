name: Build all with CMake

on: [push]

env:
  HOME_PATH: ${{ github.workspace }}
  SOURCE_PATH: src/c/main
  TEST_PATH: src/c/test
  BUILD_PATH: build
  BUILD_TYPE: Debug

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Check out repository code
      uses: actions/checkout@v2
      
    #- name: Install CLib package manager
    #  shell: bash
    #  run: |
    #    echo ">>> Install libcurl"
    #    sudo apt-get install libcurl4-gnutls-dev -qq

    #    echo ">>> Download, build and install clib"
    #    git clone https://github.com/clibs/clib.git /tmp/clib
    #    cd /tmp/clib
    #    make
    #    sudo make install

    #- name: Install CMocka library
    #  shell: bash
    #  run: |
    #    clib install cmocka

    - name: Install CMocka library
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install libcmocka-dev

    #- name: Build and install CMocka from source
    #  shell: bash
    #  run: |
    #    git clone https://git.cryptomilk.org/projects/cmocka.git  /tmp/cmocka
    #    cd /tmp/cmocka
    #    make
    #    sudo make install

    - name: Create build environment
      shell: bash
      run: |
        cmake -E make_directory ${HOME_PATH}/${BUILD_PATH}

    - name: Build makefiles from CMake files
      shell: bash
      run: |
        cd ${HOME_PATH}/${BUILD_PATH}
        cmake -DCMAKE_BUILD_TYPE=${BUILD_TYPE} ${HOME_PATH}

    - name: Build target from source code
      shell: bash
      run: |
        cd ${HOME_PATH}/${BUILD_PATH}
        cmake --build .

    #    cmake -DSOURCE_DIRECTORY="${HOME_PATH}/${SOURCE_PATH}" -DTEST_DIRECTORY="${HOME_PATH}/${TEST_PATH}" --build . --config ${BUILD_TYPE}

    - name: Execute all unit tests using CTest
      shell: bash
      run: |
        cd ${HOME_PATH}/${BUILD_PATH}
        export CMOCKA_MESSAGE_OUTPUT=STDOUT
        ctest

    #  working-directory: $BUILD_PATH
      # Execute tests defined by the CMake configuration.  
      # See https://cmake.org/cmake/help/latest/manual/ctest.1.html for more detail
    #  run: ctest -C $BUILD_TYPE
